<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时日志 - 星痕共鸣 DPS</title>
    <link rel="stylesheet" href="log-window.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="log-window">
        <!-- 日志窗口头部 -->
        <div class="log-header">
            <div class="header-left">
                <div class="log-title">
                    <span class="log-icon">📝</span>
                    <h3>实时日志</h3>
                    <span class="log-count" id="logCount">0</span>
                </div>
            </div>
            <div class="header-right">
                <div class="log-controls">
                    <select id="logLevelFilter" class="log-level-filter">
                        <option value="all">所有日志</option>
                        <option value="info">信息</option>
                        <option value="warn">警告</option>
                        <option value="error">错误</option>
                        <option value="debug">调试</option>
                    </select>
                    <button class="btn btn-sm btn-outline" id="clearLogBtn" title="清除所有日志">
                        <span class="btn-icon">🗑️</span>
                        清除
                    </button>
                    <button class="btn btn-sm btn-outline" id="exportLogBtn" title="导出日志">
                        <span class="btn-icon">📤</span>
                        导出
                    </button>
                    <button class="window-control-btn close-btn" id="closeLogBtn" title="关闭">
                        <span>✕</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 日志内容区域 -->
        <div class="log-content-wrapper">
            <div class="log-content" id="logContent">
                <div class="log-item welcome">
                    <div class="log-timestamp">刚刚</div>
                    <div class="log-message">
                        <span class="log-level info">INFO</span>
                        <span class="log-text">日志窗口已启动</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 日志底部状态栏 -->
        <div class="log-footer">
            <div class="footer-left">
                <span class="status-text">日志自动更新中...</span>
            </div>
            <div class="footer-right">
                <label class="auto-scroll-toggle">
                    <input type="checkbox" id="autoScrollCheckbox" checked>
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">自动滚动</span>
                </label>
            </div>
        </div>
    </div>

    <!-- 确认弹窗 -->
    <div id="confirmDialog" class="confirm-dialog-overlay">
        <div class="confirm-dialog">
            <div class="confirm-dialog-icon">
                ⚠️
            </div>
            <h3 class="confirm-dialog-title">确认操作</h3>
            <p class="confirm-dialog-message">确定要清除所有日志吗？此操作无法撤销。</p>
            <div class="confirm-dialog-actions">
                <button class="confirm-dialog-btn confirm-dialog-btn-cancel" id="confirmCancel">取消</button>
                <button class="confirm-dialog-btn confirm-dialog-btn-confirm" id="confirmOk">确认清除</button>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        let logMessages = [];
        let autoScroll = true;
        let currentFilter = 'all';

        // DOM元素
        let logContent, logCount, logLevelFilter, clearLogBtn, exportLogBtn, closeLogBtn, autoScrollCheckbox;

        // 初始化
        function initializeLogWindow() {
            logContent = document.getElementById('logContent');
            logCount = document.getElementById('logCount');
            logLevelFilter = document.getElementById('logLevelFilter');
            clearLogBtn = document.getElementById('clearLogBtn');
            exportLogBtn = document.getElementById('exportLogBtn');
            closeLogBtn = document.getElementById('closeLogBtn');
            autoScrollCheckbox = document.getElementById('autoScrollCheckbox');

            bindEvents();
            updateLogCount();
        }

        // 绑定事件
        function bindEvents() {
            // 日志级别过滤
            logLevelFilter.addEventListener('change', (e) => {
                currentFilter = e.target.value;
                filterLogs();
            });

            // 清除日志
            clearLogBtn.addEventListener('click', () => {
                showConfirmDialog('确定要清除所有日志吗？此操作无法撤销。', () => {
                    logMessages = [];
                    logContent.innerHTML = '';
                    updateLogCount();
                    addLogMessage('info', '日志已清除');
                });
            });

            // 导出日志
            exportLogBtn.addEventListener('click', () => {
                exportLogs();
            });

            // 关闭窗口
            closeLogBtn.addEventListener('click', () => {
                window.close();
            });

            // 自动滚动开关
            autoScrollCheckbox.addEventListener('change', (e) => {
                autoScroll = e.target.checked;
            });

            // 接收日志消息
            ipcRenderer.on('log-message', (event, level, message) => {
                addLogMessage(level, message);
            });

            // 键盘快捷键
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey) {
                    switch (e.key) {
                        case 'l':
                        case 'L':
                            e.preventDefault();
                            clearLogBtn.click();
                            break;
                        case 'e':
                        case 'E':
                            e.preventDefault();
                            exportLogBtn.click();
                            break;
                        case 'w':
                        case 'W':
                            e.preventDefault();
                            window.close();
                            break;
                    }
                }
            });
        }

        // 添加日志消息
        function addLogMessage(level, message) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            const logItem = document.createElement('div');
            logItem.className = `log-item ${level}`;
            logItem.innerHTML = `
                <div class="log-timestamp">${timeString}</div>
                <div class="log-message">
                    <span class="log-level ${level}">${level.toUpperCase()}</span>
                    <span class="log-text">${message}</span>
                </div>
            `;

            logContent.appendChild(logItem);
            
            if (autoScroll) {
                logContent.scrollTop = logContent.scrollHeight;
            }

            // 保存到内存（限制数量以节省内存）
            logMessages.push({ timestamp: timeString, level, message, element: logItem });
            
            // 限制日志数量（减少到500个以节省内存）
            if (logMessages.length > 500) {
                const removedLog = logMessages.shift();
                if (removedLog.element && removedLog.element.parentNode) {
                    removedLog.element.parentNode.removeChild(removedLog.element);
                }
            }
            
            // 更新计数
            updateLogCount();

            // 应用过滤
            filterLogs();
        }

        // 过滤日志
        function filterLogs() {
            const items = logContent.querySelectorAll('.log-item');
            items.forEach(item => {
                if (currentFilter === 'all' || item.classList.contains(currentFilter)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // 更新日志计数
        function updateLogCount() {
            logCount.textContent = logMessages.length;
        }

        // 导出日志
        function exportLogs() {
            const logText = logMessages
                .filter(log => currentFilter === 'all' || log.level === currentFilter)
                .map(log => `[${log.timestamp}] [${log.level.toUpperCase()}] ${log.message}`)
                .join('\n');

            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `star-resonance-dps-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            addLogMessage('info', '日志已导出');
        }

        // 自定义确认弹窗函数
        function showConfirmDialog(message, onConfirm, title = '确认操作') {
            const overlay = document.getElementById('confirmDialog');
            const titleElement = overlay.querySelector('.confirm-dialog-title');
            const messageElement = overlay.querySelector('.confirm-dialog-message');
            const cancelBtn = document.getElementById('confirmCancel');
            const confirmBtn = document.getElementById('confirmOk');
            
            // 设置内容
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // 显示弹窗
            overlay.classList.add('show');
            
            // 确保移除之前的事件监听器
            const newCancelBtn = cancelBtn.cloneNode(true);
            const newConfirmBtn = confirmBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            // 绑定事件
            newCancelBtn.addEventListener('click', () => {
                overlay.classList.remove('show');
            });
            
            newConfirmBtn.addEventListener('click', () => {
                overlay.classList.remove('show');
                if (onConfirm) {
                    onConfirm();
                }
            });
            
            // 点击背景关闭
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('show');
                }
            });
            
            // ESC键关闭
            const handleEscape = (e) => {
                if (e.key === 'Escape' && overlay.classList.contains('show')) {
                    overlay.classList.remove('show');
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initializeLogWindow);
    </script>
</body>
</html>