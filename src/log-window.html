<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶æ—¥å¿— - æ˜Ÿç—•å…±é¸£ DPS</title>
    <link rel="stylesheet" href="log-window.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="log-window">
        <!-- æ—¥å¿—çª—å£å¤´éƒ¨ -->
        <div class="log-header">
            <div class="header-left">
                <div class="log-title">
                    <span class="log-icon">ğŸ“</span>
                    <h3>å®æ—¶æ—¥å¿—</h3>
                    <span class="log-count" id="logCount">0</span>
                </div>
            </div>
            <div class="header-right">
                <div class="log-controls">
                    <select id="logLevelFilter" class="log-level-filter">
                        <option value="all">æ‰€æœ‰æ—¥å¿—</option>
                        <option value="info">ä¿¡æ¯</option>
                        <option value="warn">è­¦å‘Š</option>
                        <option value="error">é”™è¯¯</option>
                        <option value="debug">è°ƒè¯•</option>
                    </select>
                    <button class="btn btn-sm btn-outline" id="clearLogBtn" title="æ¸…é™¤æ‰€æœ‰æ—¥å¿—">
                        <span class="btn-icon">ğŸ—‘ï¸</span>
                        æ¸…é™¤
                    </button>
                    <button class="btn btn-sm btn-outline" id="exportLogBtn" title="å¯¼å‡ºæ—¥å¿—">
                        <span class="btn-icon">ğŸ“¤</span>
                        å¯¼å‡º
                    </button>
                    <button class="window-control-btn close-btn" id="closeLogBtn" title="å…³é—­">
                        <span>âœ•</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—å†…å®¹åŒºåŸŸ -->
        <div class="log-content-wrapper">
            <div class="log-content" id="logContent">
                <div class="log-item welcome">
                    <div class="log-timestamp">åˆšåˆš</div>
                    <div class="log-message">
                        <span class="log-level info">INFO</span>
                        <span class="log-text">æ—¥å¿—çª—å£å·²å¯åŠ¨</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—åº•éƒ¨çŠ¶æ€æ  -->
        <div class="log-footer">
            <div class="footer-left">
                <span class="status-text">æ—¥å¿—è‡ªåŠ¨æ›´æ–°ä¸­...</span>
            </div>
            <div class="footer-right">
                <label class="auto-scroll-toggle">
                    <input type="checkbox" id="autoScrollCheckbox" checked>
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">è‡ªåŠ¨æ»šåŠ¨</span>
                </label>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤å¼¹çª— -->
    <div id="confirmDialog" class="confirm-dialog-overlay">
        <div class="confirm-dialog">
            <div class="confirm-dialog-icon">
                âš ï¸
            </div>
            <h3 class="confirm-dialog-title">ç¡®è®¤æ“ä½œ</h3>
            <p class="confirm-dialog-message">ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            <div class="confirm-dialog-actions">
                <button class="confirm-dialog-btn confirm-dialog-btn-cancel" id="confirmCancel">å–æ¶ˆ</button>
                <button class="confirm-dialog-btn confirm-dialog-btn-confirm" id="confirmOk">ç¡®è®¤æ¸…é™¤</button>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        let logMessages = [];
        let autoScroll = true;
        let currentFilter = 'all';

        // DOMå…ƒç´ 
        let logContent, logCount, logLevelFilter, clearLogBtn, exportLogBtn, closeLogBtn, autoScrollCheckbox;

        // åˆå§‹åŒ–
        function initializeLogWindow() {
            logContent = document.getElementById('logContent');
            logCount = document.getElementById('logCount');
            logLevelFilter = document.getElementById('logLevelFilter');
            clearLogBtn = document.getElementById('clearLogBtn');
            exportLogBtn = document.getElementById('exportLogBtn');
            closeLogBtn = document.getElementById('closeLogBtn');
            autoScrollCheckbox = document.getElementById('autoScrollCheckbox');

            bindEvents();
            updateLogCount();
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // æ—¥å¿—çº§åˆ«è¿‡æ»¤
            logLevelFilter.addEventListener('change', (e) => {
                currentFilter = e.target.value;
                filterLogs();
            });

            // æ¸…é™¤æ—¥å¿—
            clearLogBtn.addEventListener('click', () => {
                showConfirmDialog('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚', () => {
                    logMessages = [];
                    logContent.innerHTML = '';
                    updateLogCount();
                    addLogMessage('info', 'æ—¥å¿—å·²æ¸…é™¤');
                });
            });

            // å¯¼å‡ºæ—¥å¿—
            exportLogBtn.addEventListener('click', () => {
                exportLogs();
            });

            // å…³é—­çª—å£
            closeLogBtn.addEventListener('click', () => {
                window.close();
            });

            // è‡ªåŠ¨æ»šåŠ¨å¼€å…³
            autoScrollCheckbox.addEventListener('change', (e) => {
                autoScroll = e.target.checked;
            });

            // æ¥æ”¶æ—¥å¿—æ¶ˆæ¯
            ipcRenderer.on('log-message', (event, level, message) => {
                addLogMessage(level, message);
            });

            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey) {
                    switch (e.key) {
                        case 'l':
                        case 'L':
                            e.preventDefault();
                            clearLogBtn.click();
                            break;
                        case 'e':
                        case 'E':
                            e.preventDefault();
                            exportLogBtn.click();
                            break;
                        case 'w':
                        case 'W':
                            e.preventDefault();
                            window.close();
                            break;
                    }
                }
            });
        }

        // æ·»åŠ æ—¥å¿—æ¶ˆæ¯
        function addLogMessage(level, message) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            const logItem = document.createElement('div');
            logItem.className = `log-item ${level}`;
            logItem.innerHTML = `
                <div class="log-timestamp">${timeString}</div>
                <div class="log-message">
                    <span class="log-level ${level}">${level.toUpperCase()}</span>
                    <span class="log-text">${message}</span>
                </div>
            `;

            logContent.appendChild(logItem);
            
            if (autoScroll) {
                logContent.scrollTop = logContent.scrollHeight;
            }

            // ä¿å­˜åˆ°å†…å­˜ï¼ˆé™åˆ¶æ•°é‡ä»¥èŠ‚çœå†…å­˜ï¼‰
            logMessages.push({ timestamp: timeString, level, message, element: logItem });
            
            // é™åˆ¶æ—¥å¿—æ•°é‡ï¼ˆå‡å°‘åˆ°500ä¸ªä»¥èŠ‚çœå†…å­˜ï¼‰
            if (logMessages.length > 500) {
                const removedLog = logMessages.shift();
                if (removedLog.element && removedLog.element.parentNode) {
                    removedLog.element.parentNode.removeChild(removedLog.element);
                }
            }
            
            // æ›´æ–°è®¡æ•°
            updateLogCount();

            // åº”ç”¨è¿‡æ»¤
            filterLogs();
        }

        // è¿‡æ»¤æ—¥å¿—
        function filterLogs() {
            const items = logContent.querySelectorAll('.log-item');
            items.forEach(item => {
                if (currentFilter === 'all' || item.classList.contains(currentFilter)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // æ›´æ–°æ—¥å¿—è®¡æ•°
        function updateLogCount() {
            logCount.textContent = logMessages.length;
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLogs() {
            const logText = logMessages
                .filter(log => currentFilter === 'all' || log.level === currentFilter)
                .map(log => `[${log.timestamp}] [${log.level.toUpperCase()}] ${log.message}`)
                .join('\n');

            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `star-resonance-dps-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            addLogMessage('info', 'æ—¥å¿—å·²å¯¼å‡º');
        }

        // è‡ªå®šä¹‰ç¡®è®¤å¼¹çª—å‡½æ•°
        function showConfirmDialog(message, onConfirm, title = 'ç¡®è®¤æ“ä½œ') {
            const overlay = document.getElementById('confirmDialog');
            const titleElement = overlay.querySelector('.confirm-dialog-title');
            const messageElement = overlay.querySelector('.confirm-dialog-message');
            const cancelBtn = document.getElementById('confirmCancel');
            const confirmBtn = document.getElementById('confirmOk');
            
            // è®¾ç½®å†…å®¹
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // æ˜¾ç¤ºå¼¹çª—
            overlay.classList.add('show');
            
            // ç¡®ä¿ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
            const newCancelBtn = cancelBtn.cloneNode(true);
            const newConfirmBtn = confirmBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            // ç»‘å®šäº‹ä»¶
            newCancelBtn.addEventListener('click', () => {
                overlay.classList.remove('show');
            });
            
            newConfirmBtn.addEventListener('click', () => {
                overlay.classList.remove('show');
                if (onConfirm) {
                    onConfirm();
                }
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('show');
                }
            });
            
            // ESCé”®å…³é—­
            const handleEscape = (e) => {
                if (e.key === 'Escape' && overlay.classList.contains('show')) {
                    overlay.classList.remove('show');
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeLogWindow);
    </script>
</body>
</html>