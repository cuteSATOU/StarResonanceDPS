<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPSÊÇ¨ÊµÆÁ™ó</title>
    <link rel="stylesheet" href="overlay-window.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="overlay-container">
        <!-- ÊÇ¨ÊµÆÁ™óÂ§¥ÈÉ®ÔºàÂèØÊãñÊãΩÔºâ -->
        <div class="overlay-header" id="overlayHeader">
            <div class="overlay-title">
                <span class="overlay-icon">‚ö°</span>
                <span class="title-text">DPSÁõëÊéß</span>
            </div>
            <div class="overlay-controls">
                <button class="overlay-control-btn pin-btn" id="pinBtn" title="ÂàáÊç¢ÁΩÆÈ°∂">
                    <span>üìå</span>
                </button>
                <button class="overlay-control-btn settings-btn" id="settingsBtn" title="ËÆæÁΩÆ">
                    <span>‚öôÔ∏è</span>
                </button>
                <button class="overlay-control-btn minimize-btn" id="minimizeBtn" title="ÊúÄÂ∞èÂåñ">
                    <span>‚Äì</span>
                </button>
                <button class="overlay-control-btn close-btn" id="closeBtn" title="ÂÖ≥Èó≠">
                    <span>‚úï</span>
                </button>
            </div>
        </div>

        <!-- DPSÊï∞ÊçÆÊòæÁ§∫Âå∫Âüü -->
        <div class="overlay-content">
            <!-- ‰∏ªË¶ÅDPSÊåáÊ†á -->
            <div class="dps-main">
                <div class="dps-item primary">
                    <div class="dps-label">ÂÆûÊó∂DPS</div>
                    <div class="dps-value" id="realtimeDps">0</div>
                    <div class="dps-bar">
                        <div class="dps-bar-fill" id="realtimeDpsBar"></div>
                    </div>
                </div>
                
                <div class="dps-item secondary">
                    <div class="dps-label">Â≥∞ÂÄºDPS</div>
                    <div class="dps-value" id="maxDps">0</div>
                    <div class="dps-bar">
                        <div class="dps-bar-fill max" id="maxDpsBar"></div>
                    </div>
                </div>
                
                <div class="dps-item tertiary">
                    <div class="dps-label">Âπ≥ÂùáDPS</div>
                    <div class="dps-value" id="avgDps">0</div>
                    <div class="dps-bar">
                        <div class="dps-bar-fill avg" id="avgDpsBar"></div>
                    </div>
                </div>
            </div>

            <!-- Ê≤ªÁñóÊï∞ÊçÆÊòæÁ§∫Âå∫Âüü -->
            <div class="hps-main">
                <div class="dps-item primary">
                    <div class="dps-label">ÂÆûÊó∂HPS</div>
                    <div class="dps-value" id="realtimeHps">0</div>
                    <div class="dps-bar">
                        <div class="dps-bar-fill" id="realtimeHpsBar"></div>
                    </div>
                </div>
                
                <div class="dps-item secondary">
                    <div class="dps-label">Â≥∞ÂÄºHPS</div>
                    <div class="dps-value" id="maxHps">0</div>
                    <div class="dps-bar">
                        <div class="dps-bar-fill max" id="maxHpsBar"></div>
                    </div>
                </div>
                
                <div class="dps-item tertiary">
                    <div class="dps-label">Âπ≥ÂùáHPS</div>
                    <div class="dps-value" id="avgHps">0</div>
                    <div class="dps-bar">
                        <div class="dps-bar-fill avg" id="avgHpsBar"></div>
                    </div>
                </div>
            </div>

            <!-- ËØ¶ÁªÜÁªüËÆ°ÔºàÂèØÊäòÂè†Ôºâ -->
            <div class="dps-details" id="dpsDetails">
                <div class="details-header" id="detailsToggle">
                    <span class="details-title">ËØ¶ÁªÜÁªüËÆ°</span>
                    <span class="details-arrow">‚ñº</span>
                </div>
                <div class="details-content" id="detailsContent">
                    <div class="detail-row">
                        <span class="detail-label">ÊÄª‰º§ÂÆ≥</span>
                        <span class="detail-value" id="totalDamage">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ÊÄªÊ≤ªÁñó</span>
                        <span class="detail-value" id="totalHealing">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Êö¥ÂáªÁéá</span>
                        <span class="detail-value" id="critRate">0%</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ÊîªÂáªÊ¨°Êï∞</span>
                        <span class="detail-value" id="attackCount">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Ê≤ªÁñóÊ¨°Êï∞</span>
                        <span class="detail-value" id="healingCount">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Áé©ÂÆ∂UID</span>
                        <span class="detail-value" id="playerUid">Êú™Ê£ÄÊµã</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ËÆæÁΩÆÈù¢ÊùøÔºàÈöêËóèÔºâ -->
        <div class="overlay-settings" id="overlaySettings" style="display: none;">
            <div class="settings-header">
                <h4>ÊÇ¨ÊµÆÁ™óËÆæÁΩÆ</h4>
                <button class="close-settings-btn" id="closeSettingsBtn">‚úï</button>
            </div>
            <div class="settings-content">
                <div class="setting-item">
                    <label>ÈÄèÊòéÂ∫¶</label>
                    <input type="range" id="opacitySlider" min="30" max="100" value="90" step="10">
                    <span id="opacityValue">90%</span>
                </div>
                <div class="setting-item">
                    <label>Êõ¥Êñ∞È¢ëÁéá</label>
                    <select id="updateFrequency">
                        <option value="100">100ms (ÊµÅÁïÖ)</option>
                        <option value="250" selected>250ms (Âπ≥Ë°°)</option>
                        <option value="500">500ms (ËäÇËÉΩ)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label class="checkbox-label">
                        <input type="checkbox" id="showDetailsDefault" checked>
                        <span class="checkbox-custom"></span>
                        ÈªòËÆ§ÊòæÁ§∫ËØ¶ÁªÜÁªüËÆ°
                    </label>
                </div>

                <div class="setting-item">
                    <label class="checkbox-label">
                        <input type="checkbox" id="hideHpsDisplay">
                        <span class="checkbox-custom"></span>
                        ÈöêËóèHPSÊòæÁ§∫
                    </label>
                </div>

            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        let statsData = {};
        let detailsExpanded = true;
        let updateInterval = null;
        let updateFreency = 500; // ÈªòËÆ§Èôç‰ΩéÊõ¥Êñ∞È¢ëÁéá‰ª•ËäÇÁúÅÊÄßËÉΩ
        let opacity = 90;
        let isPinned = true;
        let hideHpsDisplay = false;
        let selfOnlyMode = false;

        // DOMÂÖÉÁ¥†
        let realtimeDps, maxDps, avgDps, totalDamage, critRate, attackCount, playerUid;
        let realtimeHps, maxHps, avgHps, totalHealing, healingCount;
        let realtimeDpsBar, maxDpsBar, avgDpsBar;
        let realtimeHpsBar, maxHpsBar, avgHpsBar;
        let pinBtn, settingsBtn, minimizeBtn, closeBtn;
        let detailsToggle, detailsContent;
        let overlaySettings, closeSettingsBtn, opacitySlider, opacityValue, updateFrequencySelect;
        let showDetailsDefaultCheckbox, hideHpsDisplayCheckbox;

        // ÂàùÂßãÂåñ
        function initializeOverlay() {
            // Ëé∑ÂèñDOMÂÖÉÁ¥†
            realtimeDps = document.getElementById('realtimeDps');
            maxDps = document.getElementById('maxDps');
            avgDps = document.getElementById('avgDps');
            totalDamage = document.getElementById('totalDamage');
            realtimeHps = document.getElementById('realtimeHps');
            maxHps = document.getElementById('maxHps');
            avgHps = document.getElementById('avgHps');
            totalHealing = document.getElementById('totalHealing');
            healingCount = document.getElementById('healingCount');
            critRate = document.getElementById('critRate');
            attackCount = document.getElementById('attackCount');
            playerUid = document.getElementById('playerUid');
            
            // Ë∞ÉËØïÔºöÊ£ÄÊü•DOMÂÖÉÁ¥†ÊòØÂê¶Ê≠£Á°ÆËé∑Âèñ
            console.log('ÊÇ¨ÊµÆÁ™óDOMÂÖÉÁ¥†ÂàùÂßãÂåñ:', {
                playerUid: playerUid,
                playerUidExists: !!playerUid
            });
            
            realtimeDpsBar = document.getElementById('realtimeDpsBar');
            maxDpsBar = document.getElementById('maxDpsBar');
            avgDpsBar = document.getElementById('avgDpsBar');
            realtimeHpsBar = document.getElementById('realtimeHpsBar');
            maxHpsBar = document.getElementById('maxHpsBar');
            avgHpsBar = document.getElementById('avgHpsBar');
            
            pinBtn = document.getElementById('pinBtn');
            settingsBtn = document.getElementById('settingsBtn');
            minimizeBtn = document.getElementById('minimizeBtn');
            closeBtn = document.getElementById('closeBtn');
            detailsToggle = document.getElementById('detailsToggle');
            detailsContent = document.getElementById('detailsContent');
            
            overlaySettings = document.getElementById('overlaySettings');
            closeSettingsBtn = document.getElementById('closeSettingsBtn');
            opacitySlider = document.getElementById('opacitySlider');
            opacityValue = document.getElementById('opacityValue');
            updateFrequencySelect = document.getElementById('updateFrequency');
            showDetailsDefaultCheckbox = document.getElementById('showDetailsDefault');
            hideHpsDisplayCheckbox = document.getElementById('hideHpsDisplay');

            bindEvents();
            loadSettings();
            updatePinButton();
            
            // Á°Æ‰øùËØ¶ÁªÜÁªüËÆ°ÈªòËÆ§Â±ïÂºÄ
            if (detailsContent) {
                detailsContent.style.display = detailsExpanded ? 'block' : 'none';
                const arrow = document.querySelector('.details-arrow');
                if (arrow) {
                    arrow.textContent = detailsExpanded ? '‚ñº' : '‚ñ∂';
                }
                console.log('ËØ¶ÁªÜÁªüËÆ°Â±ïÂºÄÁä∂ÊÄÅ:', detailsExpanded);
            }
            
            startDataUpdate();
            
            // ÂàùÂßãÂåñÊó∂Ë∞ÉÊï¥Á™óÂè£Â§ßÂ∞è
            setTimeout(() => {
                adjustWindowSize();
            }, 100);
        }

        // ÁªëÂÆö‰∫ã‰ª∂
        function bindEvents() {
            console.log('ÂºÄÂßãÁªëÂÆö‰∫ã‰ª∂ÔºåÊ£ÄÊü•DOMÂÖÉÁ¥†:', {
                pinBtn: !!pinBtn,
                settingsBtn: !!settingsBtn,
                minimizeBtn: !!minimizeBtn,
                closeBtn: !!closeBtn,
                detailsToggle: !!detailsToggle,
                closeSettingsBtn: !!closeSettingsBtn,
                opacitySlider: !!opacitySlider,
                updateFrequencySelect: !!updateFrequencySelect,
                showDetailsDefaultCheckbox: !!showDetailsDefaultCheckbox
            });

            // ÁΩÆÈ°∂ÊåâÈíÆ
            if (pinBtn) {
                pinBtn.addEventListener('click', () => {
                    console.log('ÁΩÆÈ°∂ÊåâÈíÆË¢´ÁÇπÂáª');
                    isPinned = !isPinned;
                    ipcRenderer.invoke('overlay-set-always-on-top', isPinned);
                    updatePinButton();
                });
            } else {
                console.error('ÁΩÆÈ°∂ÊåâÈíÆÂÖÉÁ¥†Êú™ÊâæÂà∞');
            }

            // ÊéßÂà∂ÊåâÈíÆ
            if (settingsBtn && overlaySettings) {
                settingsBtn.addEventListener('click', () => {
                    console.log('ËÆæÁΩÆÊåâÈíÆË¢´ÁÇπÂáª');
                    overlaySettings.style.display = overlaySettings.style.display === 'none' ? 'block' : 'none';
                });
            } else {
                console.error('ËÆæÁΩÆÊåâÈíÆÊàñËÆæÁΩÆÈù¢ÊùøÂÖÉÁ¥†Êú™ÊâæÂà∞');
            }

            if (minimizeBtn) {
                minimizeBtn.addEventListener('click', () => {
                    console.log('ÊúÄÂ∞èÂåñÊåâÈíÆË¢´ÁÇπÂáª');
                    ipcRenderer.invoke('overlay-minimize');
                });
            } else {
                console.error('ÊúÄÂ∞èÂåñÊåâÈíÆÂÖÉÁ¥†Êú™ÊâæÂà∞');
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    console.log('ÂÖ≥Èó≠ÊåâÈíÆË¢´ÁÇπÂáª');
                    ipcRenderer.invoke('overlay-close');
                });
            } else {
                console.error('ÂÖ≥Èó≠ÊåâÈíÆÂÖÉÁ¥†Êú™ÊâæÂà∞');
            }

            // ËØ¶ÁªÜÁªüËÆ°ÊäòÂè†
            if (detailsToggle && detailsContent) {
                detailsToggle.addEventListener('click', () => {
                    console.log('ËØ¶ÁªÜÁªüËÆ°ÊäòÂè†ÊåâÈíÆË¢´ÁÇπÂáª');
                    detailsExpanded = !detailsExpanded;
                    detailsContent.style.display = detailsExpanded ? 'block' : 'none';
                    const arrow = document.querySelector('.details-arrow');
                    if (arrow) {
                        arrow.textContent = detailsExpanded ? '‚ñº' : '‚ñ∂';
                    }
                    adjustWindowSize();
                });
            } else {
                console.error('ËØ¶ÁªÜÁªüËÆ°ÊäòÂè†ÊåâÈíÆÊàñÂÜÖÂÆπÂÖÉÁ¥†Êú™ÊâæÂà∞');
            }

            // ËÆæÁΩÆÈù¢Êùø
            if (closeSettingsBtn && overlaySettings) {
                closeSettingsBtn.addEventListener('click', () => {
                    console.log('ÂÖ≥Èó≠ËÆæÁΩÆÊåâÈíÆË¢´ÁÇπÂáª');
                    overlaySettings.style.display = 'none';
                });
            } else {
                console.error('ÂÖ≥Èó≠ËÆæÁΩÆÊåâÈíÆÊàñËÆæÁΩÆÈù¢ÊùøÂÖÉÁ¥†Êú™ÊâæÂà∞');
            }

            // ÈÄèÊòéÂ∫¶ËÆæÁΩÆ
            if (opacitySlider && opacityValue) {
                opacitySlider.addEventListener('input', (e) => {
                    console.log('ÈÄèÊòéÂ∫¶ÊªëÂùóË¢´Ë∞ÉÊï¥:', e.target.value);
                    opacity = parseInt(e.target.value);
                    opacityValue.textContent = opacity + '%';
                    document.body.style.opacity = opacity / 100;
                    saveSettings();
                });
            } else {
                console.error('ÈÄèÊòéÂ∫¶ÊªëÂùóÊàñÊòæÁ§∫ÂÖÉÁ¥†Êú™ÊâæÂà∞');
            }

            // Êõ¥Êñ∞È¢ëÁéáËÆæÁΩÆ
            if (updateFrequencySelect) {
                updateFrequencySelect.addEventListener('change', (e) => {
                    console.log('Êõ¥Êñ∞È¢ëÁéáË¢´‰øÆÊîπ:', e.target.value);
                    updateFreency = parseInt(e.target.value);
                    restartDataUpdate();
                    saveSettings();
                });
            } else {
                console.error('Êõ¥Êñ∞È¢ëÁéáÈÄâÊã©ÂÖÉÁ¥†Êú™ÊâæÂà∞');
            }

            // ÈªòËÆ§ÊòæÁ§∫ËØ¶ÁªÜÁªüËÆ°
            if (showDetailsDefaultCheckbox && detailsContent) {
                showDetailsDefaultCheckbox.addEventListener('change', (e) => {
                    console.log('ÈªòËÆ§ÊòæÁ§∫ËØ¶ÁªÜÁªüËÆ°Â§çÈÄâÊ°ÜË¢´‰øÆÊîπ:', e.target.checked);
                    detailsExpanded = e.target.checked;
                    detailsContent.style.display = detailsExpanded ? 'block' : 'none';
                    const arrow = document.querySelector('.details-arrow');
                    if (arrow) {
                        arrow.textContent = detailsExpanded ? '‚ñº' : '‚ñ∂';
                    }
                    adjustWindowSize();
                    saveSettings();
                });
            } else {
                console.error('ÈªòËÆ§ÊòæÁ§∫ËØ¶ÁªÜÁªüËÆ°Â§çÈÄâÊ°ÜÊàñËØ¶ÁªÜÂÜÖÂÆπÂÖÉÁ¥†Êú™ÊâæÂà∞');
            }

            // ÈöêËóèHPSÊòæÁ§∫
            if (hideHpsDisplayCheckbox) {
                hideHpsDisplayCheckbox.addEventListener('change', (e) => {
                    console.log('ÈöêËóèHPSÊòæÁ§∫Â§çÈÄâÊ°ÜË¢´‰øÆÊîπ:', e.target.checked);
                    hideHpsDisplay = e.target.checked;
                    toggleHpsDisplay();
                    adjustWindowSize();
                    saveSettings();
                });
            } else {
                console.error('ÈöêËóèHPSÊòæÁ§∫Â§çÈÄâÊ°ÜÊú™ÊâæÂà∞');
            }



            // ÂéüÊù•ÁöÑÊï∞ÊçÆÊõ¥Êñ∞ÁõëÂê¨Âô®Â∑≤ÁßªÂà∞‰∏ãÈù¢ÔºåÊ∑ªÂä†‰∫ÜË∞ÉËØï‰ø°ÊÅØ

            // Êé•Êî∂Áé©ÂÆ∂UIDÊõ¥Êñ∞
            ipcRenderer.on('player-uid-updated', (event, uid) => {
                console.log('ÊÇ¨ÊµÆÁ™óÊî∂Âà∞UIDÊõ¥Êñ∞‰∫ã‰ª∂:', {
                    uid: uid,
                    uidType: typeof uid,
                    playerUidElement: playerUid,
                    playerUidExists: !!playerUid,
                    timestamp: new Date().toISOString()
                });
                
                if (playerUid) {
                    const displayUid = uid || 'Êú™Ê£ÄÊµã';
                    playerUid.textContent = displayUid;
                    console.log('UIDÂ∑≤Êõ¥Êñ∞Âà∞ÊÇ¨ÊµÆÁ™óÔºåÂΩìÂâçÊòæÁ§∫:', displayUid);
                    
                    // Âº∫Âà∂Ëß¶ÂèëDOMÊõ¥Êñ∞
                    playerUid.style.color = uid ? '#4CAF50' : '#f44336';
                } else {
                    console.error('playerUid DOMÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºÅÊó†Ê≥ïÊõ¥Êñ∞UIDÊòæÁ§∫');
                }
            });

            // Êé•Êî∂"‰ªÖËá™Â∑±"Ê®°ÂºèÂàáÊç¢
            ipcRenderer.on('self-only-mode-changed', (event, enabled) => {
                console.log('ÊÇ¨ÊµÆÁ™óÊî∂Âà∞"‰ªÖËá™Â∑±"Ê®°ÂºèÂàáÊç¢:', enabled);
                selfOnlyMode = enabled;
                console.log('ÊÇ¨ÊµÆÁ™ó"‰ªÖËá™Â∑±"Ê®°ÂºèÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫:', selfOnlyMode);
            });

            // Êé•Êî∂Êï∞ÊçÆÊõ¥Êñ∞
            ipcRenderer.on('stats-updated', (event, data) => {
                console.log('ÊÇ¨ÊµÆÁ™óÊî∂Âà∞Êï∞ÊçÆÊõ¥Êñ∞:', {
                    selfOnlyMode: selfOnlyMode,
                    dataKeys: Object.keys(data),
                    dataCount: Object.keys(data).length
                });
                statsData = data;
                updateDpsDisplay();
            });
        }

        // ÂºÄÂßãÊï∞ÊçÆÊõ¥Êñ∞
        function startDataUpdate() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            updateInterval = setInterval(() => {
                ipcRenderer.invoke('get-stats-data').then(data => {
                    if (data) {
                        statsData = data;
                        updateDpsDisplay();
                    }
                });
            }, updateFreency);

            // Ëé∑ÂèñÂΩìÂâçÁé©ÂÆ∂UID
            console.log('ÊÇ¨ÊµÆÁ™óÂºÄÂßãËé∑ÂèñÂΩìÂâçUID...');
            ipcRenderer.invoke('get-player-uid').then(uid => {
                console.log('ÊÇ¨ÊµÆÁ™óget-player-uidÂìçÂ∫î:', {
                    uid: uid,
                    hasUid: !!uid,
                    playerUidElement: playerUid,
                    playerUidExists: !!playerUid
                });
                
                if (playerUid) {
                    const displayUid = uid || 'Êú™Ê£ÄÊµã';
                    playerUid.textContent = displayUid;
                    playerUid.style.color = uid ? '#4CAF50' : '#f44336';
                    console.log('ÊÇ¨ÊµÆÁ™ó‰∏ªÂä®Ëé∑ÂèñUIDÊàêÂäüÔºåËÆæÁΩÆ‰∏∫:', displayUid);
                } else {
                    console.error('playerUid DOMÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºÅ');
                }
            }).catch(err => {
                console.error('Ëé∑ÂèñÁé©ÂÆ∂UIDÂ§±Ë¥•:', err);
                if (playerUid) {
                    playerUid.textContent = 'Ëé∑ÂèñÂ§±Ë¥•';
                    playerUid.style.color = '#f44336';
                }
            });
        }

        // ÈáçÂêØÊï∞ÊçÆÊõ¥Êñ∞
        function restartDataUpdate() {
            startDataUpdate();
        }

        // Ëá™Âä®Ë∞ÉÊï¥Á™óÂè£Â§ßÂ∞è
        function adjustWindowSize() {
            // Á≠âÂæÖDOMÊõ¥Êñ∞ÂÆåÊàê
            setTimeout(() => {
                const container = document.querySelector('.overlay-container');
                if (container) {
                    const rect = container.getBoundingClientRect();
                    const newWidth = Math.max(280, Math.min(500, rect.width + 20)); // Ê∑ªÂä†‰∏Ä‰∫õËæπË∑ù
                    const newHeight = Math.max(200, Math.min(800, rect.height + 20));
                    
                    ipcRenderer.invoke('overlay-resize', {
                        width: Math.ceil(newWidth),
                        height: Math.ceil(newHeight)
                    });
                }
            }, 50);
        }

        // ÂàáÊç¢HPSÊòæÁ§∫
        function toggleHpsDisplay() {
            console.log('ÂàáÊç¢HPSÊòæÁ§∫Áä∂ÊÄÅ:', hideHpsDisplay);
            
            // ÈöêËóèÊï¥‰∏™HPS‰∏ªÊòæÁ§∫Âå∫Âüü
            const hpsMain = document.querySelector('.hps-main');
            if (hpsMain) {
                hpsMain.style.display = hideHpsDisplay ? 'none' : '';
                console.log('HPS‰∏ªÂå∫ÂüüÊòæÁ§∫Áä∂ÊÄÅ:', hpsMain.style.display);
            } else {
                console.error('Êú™ÊâæÂà∞.hps-mainÂÖÉÁ¥†');
            }
            
            // ÈöêËóèËØ¶ÁªÜÁªüËÆ°‰∏≠ÁöÑHPSÁõ∏ÂÖ≥È°πÁõÆ
            const totalHealingRow = document.getElementById('totalHealing')?.closest('.detail-row');
            const healingCountRow = document.getElementById('healingCount')?.closest('.detail-row');
            
            if (totalHealingRow) {
                totalHealingRow.style.display = hideHpsDisplay ? 'none' : '';
                console.log('ÊÄªÊ≤ªÁñóË°åÊòæÁ§∫Áä∂ÊÄÅ:', totalHealingRow.style.display);
            } else {
                console.error('Êú™ÊâæÂà∞ÊÄªÊ≤ªÁñóË°åÂÖÉÁ¥†');
            }
            
            if (healingCountRow) {
                healingCountRow.style.display = hideHpsDisplay ? 'none' : '';
                console.log('Ê≤ªÁñóÊ¨°Êï∞Ë°åÊòæÁ§∫Áä∂ÊÄÅ:', healingCountRow.style.display);
            } else {
                console.error('Êú™ÊâæÂà∞Ê≤ªÁñóÊ¨°Êï∞Ë°åÂÖÉÁ¥†');
            }
        }

        // Êõ¥Êñ∞DPSÊòæÁ§∫
        function updateDpsDisplay() {
            const userIds = Object.keys(statsData);
            
            if (userIds.length === 0) {
                // Êó†Êï∞ÊçÆÊó∂ÊòæÁ§∫0
                realtimeDps.textContent = '0';
                maxDps.textContent = '0';
                avgDps.textContent = '0';
                totalDamage.textContent = '0';
                realtimeHps.textContent = '0';
                maxHps.textContent = '0';
                avgHps.textContent = '0';
                totalHealing.textContent = '0';
                healingCount.textContent = '0';
                critRate.textContent = '0%';
                attackCount.textContent = '0';
                updateProgressBars(0, 0, 0, 0, 0, 0);
                adjustWindowSize();
                return;
            }

            // ËÆ°ÁÆóÊÄª‰ΩìÊï∞ÊçÆ
            let totalRealtimeDpsValue = 0;
            let totalMaxDpsValue = 0;
            let totalAvgDpsValue = 0;
            let totalDamageValue = 0;
            let totalRealtimeHpsValue = 0;
            let totalMaxHpsValue = 0;
            let totalAvgHpsValue = 0;
            let totalHealingValue = 0;
            let totalHealingCountValue = 0;
            let totalCritCount = 0;
            let totalAttackCount = 0;

            for (const uid of userIds) {
                const userData = statsData[uid];
                totalRealtimeDpsValue += userData.realtime_dps || 0;
                totalMaxDpsValue = Math.max(totalMaxDpsValue, userData.realtime_dps_max || 0);
                totalAvgDpsValue += userData.total_dps || 0;
                totalDamageValue += userData.total_damage.total || 0;
                totalRealtimeHpsValue += userData.realtime_hps || 0;
                totalMaxHpsValue = Math.max(totalMaxHpsValue, userData.realtime_hps_max || 0);
                totalAvgHpsValue += userData.total_hps || 0;
                totalHealingValue += userData.total_healing ? userData.total_healing.total || 0 : 0;
                totalHealingCountValue += userData.healing_count ? userData.healing_count.total || 0 : 0;
                totalCritCount += userData.total_count.critical || 0;
                totalAttackCount += userData.total_count.total || 0;
            }

            if (userIds.length > 0) {
                totalAvgDpsValue = totalAvgDpsValue / userIds.length;
                totalAvgHpsValue = totalAvgHpsValue / userIds.length;
            }

            const critRateValue = totalAttackCount > 0 ? (totalCritCount / totalAttackCount) : 0;

            // Êõ¥Êñ∞ÊòæÁ§∫
            realtimeDps.textContent = formatNumber(totalRealtimeDpsValue);
            maxDps.textContent = formatNumber(totalMaxDpsValue);
            avgDps.textContent = formatNumber(totalAvgDpsValue);
            totalDamage.textContent = formatNumber(totalDamageValue);
            realtimeHps.textContent = formatNumber(totalRealtimeHpsValue);
            maxHps.textContent = formatNumber(totalMaxHpsValue);
            avgHps.textContent = formatNumber(totalAvgHpsValue);
            totalHealing.textContent = formatNumber(totalHealingValue);
            healingCount.textContent = totalHealingCountValue.toString();
            critRate.textContent = (critRateValue * 100).toFixed(1) + '%';
            attackCount.textContent = totalAttackCount.toString();

            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            updateProgressBars(totalRealtimeDpsValue, totalMaxDpsValue, totalAvgDpsValue, totalRealtimeHpsValue, totalMaxHpsValue, totalAvgHpsValue);
            
            // Ë∞ÉÊï¥Á™óÂè£Â§ßÂ∞è
            adjustWindowSize();
        }

        // Êõ¥Êñ∞ËøõÂ∫¶Êù°
        function updateProgressBars(realtime, max, avg, realtimeHps, maxHps, avgHps) {
            // DPSËøõÂ∫¶Êù°
            const maxDpsValue = Math.max(realtime, max, avg) || 1;
            
            const realtimePercent = (realtime / maxDpsValue) * 100;
            const maxPercent = (max / maxDpsValue) * 100;
            const avgPercent = (avg / maxDpsValue) * 100;
            
            realtimeDpsBar.style.width = `${Math.min(realtimePercent, 100)}%`;
            maxDpsBar.style.width = `${Math.min(maxPercent, 100)}%`;
            avgDpsBar.style.width = `${Math.min(avgPercent, 100)}%`;
            
            // HPSËøõÂ∫¶Êù°
            const maxHpsValue = Math.max(realtimeHps, maxHps, avgHps) || 1;
            
            const realtimeHpsPercent = (realtimeHps / maxHpsValue) * 100;
            const maxHpsPercent = (maxHps / maxHpsValue) * 100;
            const avgHpsPercent = (avgHps / maxHpsValue) * 100;
            
            if (realtimeHpsBar) realtimeHpsBar.style.width = `${Math.min(realtimeHpsPercent, 100)}%`;
            if (maxHpsBar) maxHpsBar.style.width = `${Math.min(maxHpsPercent, 100)}%`;
            if (avgHpsBar) avgHpsBar.style.width = `${Math.min(avgHpsPercent, 100)}%`;
        }

        // Ê†ºÂºèÂåñÊï∞Â≠ó
        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) return '0';
            
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            } else {
                return Math.floor(num).toString();
            }
        }

        // Êõ¥Êñ∞ÁΩÆÈ°∂ÊåâÈíÆÁä∂ÊÄÅ
        function updatePinButton() {
            if (pinBtn) {
                const pinIcon = pinBtn.querySelector('span');
                if (isPinned) {
                    pinIcon.textContent = 'üìå';
                    pinBtn.style.background = 'rgba(255, 255, 255, 0.3)';
                    pinBtn.title = 'ÁÇπÂáªÂèñÊ∂àÁΩÆÈ°∂';
                } else {
                    pinIcon.textContent = 'üìç';
                    pinBtn.style.background = 'rgba(255, 255, 255, 0.1)';
                    pinBtn.title = 'ÁÇπÂáªÁΩÆÈ°∂ÊòæÁ§∫';
                }
            }
        }

        // ‰øùÂ≠òËÆæÁΩÆ
        function saveSettings() {
            const settings = {
                opacity,
                updateFreency,
                detailsExpanded,
                isPinned,
                hideHpsDisplay
            };
            localStorage.setItem('overlaySettings', JSON.stringify(settings));
        }

        // Âä†ËΩΩËÆæÁΩÆ
        function loadSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('overlaySettings') || '{}');
                
                if (settings.opacity !== undefined) {
                    opacity = settings.opacity;
                    opacitySlider.value = opacity;
                    opacityValue.textContent = opacity + '%';
                    document.body.style.opacity = opacity / 100;
                }
                
                if (settings.updateFreency !== undefined) {
                    updateFreency = settings.updateFreency;
                    updateFrequencySelect.value = updateFreency;
                }
                
                if (settings.detailsExpanded !== undefined) {
                    detailsExpanded = settings.detailsExpanded;
                    showDetailsDefaultCheckbox.checked = detailsExpanded;
                    detailsContent.style.display = detailsExpanded ? 'block' : 'none';
                    document.querySelector('.details-arrow').textContent = detailsExpanded ? '‚ñº' : '‚ñ∂';
                }
                
                if (settings.isPinned !== undefined) {
                    isPinned = settings.isPinned;
                    ipcRenderer.invoke('overlay-set-always-on-top', isPinned);
                    updatePinButton();
                }
                
                if (settings.hideHpsDisplay !== undefined) {
                    hideHpsDisplay = settings.hideHpsDisplay;
                    hideHpsDisplayCheckbox.checked = hideHpsDisplay;
                    toggleHpsDisplay();
                }
            } catch (error) {
                console.error('Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•:', error);
            }
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', initializeOverlay);

        // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            // Ê∏ÖÁêÜÊï∞ÊçÆÂºïÁî®
            statsData = null;
        });
    </script>
</body>
</html>